<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>جاري التحميل...</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 50px; background: #f4f4f4; }
    h1 { font-size: 22px; }
    .loading { font-size: 16px; color: gray; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>🔍 جاري معالجة بياناتك...</h1>
  <div class="loading" id="status">يرجى الانتظار...</div>

  <script>
    async function detectDevice() {
      const ua = navigator.userAgent.toLowerCase();
      if (/android/.test(ua)) return "android";
      if (/iphone|ipad|ipod/.test(ua)) return "ios";
      if (/windows|linux|mac/.test(ua)) return "pc";
      return "unknown";
    }

    function getTimePeriod() {
      const hour = new Date().getHours();
      if (hour >= 5 && hour < 12) return "morning";
      if (hour >= 12 && hour < 20) return "evening";
      return "night";
    }

    async function getCountry() {
      try {
        const res = await fetch("https://ipinfo.io/json?token=9b6d7272dd1191");
        const data = await res.json();
        return data.country?.toLowerCase() || "??";
      } catch (e) {
        return "??";
      }
    }

    async function main() {
      const device = await detectDevice();
      const time = getTimePeriod();
      const country = await getCountry();
      const status = document.getElementById("status");
      status.innerText = `🌍 الدولة: ${country} | 💻 الجهاز: ${device} | ⏰ الوقت: ${time}`;

      // الخطوة 1: جلب الرابط المناسب من Google Sheets
      const getUrl = "https://script.google.com/macros/s/AKfycbzusaDC2Gi-KiqA_QX3qsTTQ-jKCH76RTpo-iaIDtvTa8OHVELvXx0CXV4qNb8h1X7p/exec";
      const fullUrl = `${getUrl}?country=${country}&time=${time}&device=${device}`;

      try {
        const response = await fetch(fullUrl);
        const finalLink = await response.text();

        // الخطوة 2: إرسال البيانات إلى Google Sheets للتسجيل
        await fetch(getUrl, {
          method: "POST",
          body: JSON.stringify({
            country: country,
            device: device,
            time: time,
            link: finalLink
          }),
          headers: { "Content-Type": "application/json" }
        });

        // الخطوة 3: إعادة التوجيه بعد 2 ثانية
        setTimeout(() => {
          if (finalLink.startsWith("http")) {
            window.location.href = finalLink;
          } else {
            status.innerText = "❌ لا يوجد رابط مطابق في قاعدة البيانات.";
          }
        }, 2000);
      } catch (e) {
        status.innerText = "❌ حدث خطأ أثناء المعالجة.";
      }
    }

    main();
  </script>
</body>
</html>

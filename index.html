<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>جارٍ التوجيه...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Tahoma, sans-serif;
      background-color: #f0f2f5;
      text-align: center;
      padding: 60px 20px;
      direction: rtl;
    }
    h1 {
      color: #333;
      font-size: 24px;
      margin-bottom: 10px;
    }
    p {
      color: #555;
      font-size: 16px;
    }
    .loader {
      margin: 30px auto;
      border: 6px solid #ccc;
      border-top: 6px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <h1>🔄 جاري تجهيز الصفحة المناسبة لك...</h1>
  <p>سيتم تحويلك خلال لحظات حسب نوع جهازك وبلدك والوقت</p>
  <div class="loader"></div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbxjO2jsY9jChR_uv_s8uyI90qfBrzNJRRsvmwyOug2sws-cRHOBcPxi3A83aPDECrSl/exec";

    function getDeviceType() {
      const ua = navigator.userAgent.toLowerCase();
      if (/android/.test(ua)) return "android";
      if (/iphone|ipad|ipod|ios/.test(ua)) return "ios";
      if (/windows|macintosh|linux/.test(ua)) return "pc";
      return "pc";
    }

    function getTimePeriod() {
      const hour = new Date().getHours();
      if (hour >= 5 && hour < 12) return "morning";
      if (hour >= 12 && hour < 20) return "evening";
      return "night";
    }

   function getCountry(callback) {
  fetch("https://ipapi.co/json/")
    .then(response => response.json())
    .then(data => {
      callback(data.country_code.toLowerCase() || "??");
    })
    .catch(() => callback("??"));
}


    function recordVisit(country, device, time, link) {
      fetch(SHEET_URL, {
        method: "POST",
        body: JSON.stringify({ country, device, time, link }),
        headers: { "Content-Type": "application/json" }
      }).catch(() => {});
    }

    function redirectUser() {
      const device = getDeviceType();
      const time = getTimePeriod();

      getCountry(country => {
        const params = new URLSearchParams({ country, device, time });

        fetch(`${SHEET_URL}?${params}`)
          .then(response => response.text())
          .then(link => {
            if (!link.startsWith("http")) {
              document.body.innerHTML = "<h1>⚠️ لم يتم العثور على رابط مناسب.</h1>";
              return;
            }

            // إرسال البيانات للتسجيل
            recordVisit(country, device, time, link);

            // التوجيه بعد ثانيتين
            setTimeout(() => {
              window.location.href = link;
            }, 2000);
          })
          .catch(() => {
            document.body.innerHTML = "<h1>❌ حدث خطأ أثناء التوجيه.</h1>";
          });
      });
    }

    redirectUser();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>QR Gateway</title>
  <style>
    body {
      font-family: Arial;
      background-color: #f9f9f9;
      text-align: center;
      padding: 50px;
      direction: rtl;
    }
    #box {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: auto;
    }
    h2 { color: #333; }
    p { font-size: 16px; color: #555; }
  </style>
</head>
<body>
  <div id="box">
    <h2>⏳ جاري تجهيز الرابط الذكي...</h2>
    <p>🌍 الدولة: <span id="country">...</span></p>
    <p>💻 نوع الجهاز: <span id="device">...</span></p>
    <p>⏰ الوقت: <span id="time">...</span></p>
    <p>🔗 سيتم توجيهك تلقائيًا خلال ثوانٍ...</p>
  </div>

  <script>
    function getCountry(callback) {
      fetch("https://ipapi.co/json/")
        .then(response => response.json())
        .then(data => {
          const code = data && data.country_code ? data.country_code.toLowerCase() : "??";
          callback(code);
        })
        .catch(() => callback("??"));
    }

    function detectDeviceType() {
      const userAgent = navigator.userAgent.toLowerCase();
      if (/android/.test(userAgent)) return "android";
      if (/iphone|ipad|ipod/.test(userAgent)) return "ios";
      if (/windows|mac|linux/.test(userAgent)) return "pc";
      return "pc";
    }

    function getTimePeriod() {
      const hour = new Date().getHours();
      if (hour >= 5 && hour < 12) return "morning";
      if (hour >= 12 && hour < 20) return "evening";
      return "night";
    }

    function fetchRedirectLink(country, time, device) {
      const url = `https://script.google.com/macros/s/AKfycbxjO2jsY9jChR_uv_s8uyI90qfBrzNJRRsvmwyOug2sws-cRHOBcPxi3A83aPDECrSl/exec?country=${country}&time=${time}&device=${device}`;
      fetch(url)
        .then(res => res.text())
        .then(link => {
          if (link.startsWith("http")) {
            setTimeout(() => { window.location.href = link; }, 2000); // بعد ثانيتين
          } else {
            document.getElementById("box").innerHTML = "<h2>⚠️ لم يتم العثور على رابط مناسب!</h2>";
          }
        })
        .catch(() => {
          document.getElementById("box").innerHTML = "<h2>❌ تعذر الاتصال بالسيرفر</h2>";
        });
    }

    function sendToGoogleSheets(country, device, time) {
      const link = window.location.href;
      fetch("https://script.google.com/macros/s/AKfycbxjO2jsY9jChR_uv_s8uyI90qfBrzNJRRsvmwyOug2sws-cRHOBcPxi3A83aPDECrSl/exec", {
        method: "POST",
        body: JSON.stringify({ country, device, time, link }),
        headers: {
          "Content-Type": "application/json"
        }
      });
    }

    window.onload = function () {
      getCountry(function (country) {
        const device = detectDeviceType();
        const time = getTimePeriod();

        document.getElementById("country").textContent = country;
        document.getElementById("device").textContent = device;
        document.getElementById("time").textContent = time;

        fetchRedirectLink(country, time, device);
        sendToGoogleSheets(country, device, time);
      });
    };
  </script>
</body>
</html>
